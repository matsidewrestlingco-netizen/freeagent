<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreeAgents — Supabase Test Harness</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 980px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    label { display:block; font-size: 12px; color:#444; margin-top: 10px; }
    input, button, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; margin-top: 6px; box-sizing: border-box; }
    button { cursor:pointer; font-weight: 600; }
    button.secondary { background: #f4f4f4; }
    button.danger { background: #ffe9e9; }
    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }
    pre { background:#0b1020; color:#e9eefc; padding: 12px; border-radius: 12px; overflow:auto; }
    .muted { color:#666; font-size: 12px; }
    .ok { color: #0a7a2f; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .list { display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .item { border: 1px solid #eee; border-radius: 10px; padding: 10px; }
    .item h4 { margin: 0 0 6px 0; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>FreeAgents — Supabase Test Harness</h1>
  <p class="muted">
    This is a quick local UI to validate Auth + RLS + basic writes/reads in your <code>freeagents</code> schema.
  </p>

  <div class="card">
    <h3>1) Configure Supabase</h3>
    <label>Supabase URL</label>
    <input id="supabaseUrl" placeholder="https://xxxx.supabase.co" />
    <label>Supabase Anon Key</label>
    <textarea id="supabaseKey" rows="3" placeholder="eyJhbGciOiJIUzI1NiIsInR..."></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="btnInit">Initialize</button>
      <button id="btnClear" class="secondary">Clear</button>
    </div>
    <div id="initStatus" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h3>2) Auth</h3>

      <label>Email</label>
      <input id="email" type="email" placeholder="you@email.com" />

      <label>Password (for sign-up / password login)</label>
      <input id="password" type="password" placeholder="••••••••" />

      <div class="row" style="margin-top:10px;">
        <button id="btnSignUp">Sign up (email+password)</button>
        <button id="btnSignIn">Sign in (email+password)</button>
      </div>

      <label style="margin-top:12px;">Magic link (OTP) — email only</label>
      <button id="btnMagic" class="secondary">Send magic link</button>

      <div class="row" style="margin-top:10px;">
        <button id="btnSignOut" class="danger">Sign out</button>
        <button id="btnRefresh" class="secondary">Refresh session</button>
      </div>

      <div id="authStatus" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>3) Session</h3>
      <div class="muted">User ID is what your RLS relies on (<code>auth.uid()</code>).</div>
      <pre id="sessionDump">{ "session": null }</pre>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card">
      <h3>4) Create Tournament</h3>
      <div class="muted">This inserts into <code>freeagents.tournaments</code> using the logged-in user.</div>

      <label>Tournament Name</label>
      <input id="tName" placeholder="Example Duals" />

      <div class="row">
        <div>
          <label>Start Date</label>
          <input id="tStart" type="date" />
        </div>
        <div>
          <label>End Date (optional)</label>
          <input id="tEnd" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>City (optional)</label>
          <input id="tCity" placeholder="Pittsburgh" />
        </div>
        <div>
          <label>State (optional)</label>
          <input id="tState" placeholder="PA" />
        </div>
      </div>

      <button id="btnCreateTournament" style="margin-top:10px;">Create Tournament</button>
      <div id="createTournamentStatus" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>5) List Tournaments</h3>
      <div class="row" style="margin-top:10px;">
        <button id="btnLoadTournaments">Load Tournaments</button>
        <button id="btnLoadMine" class="secondary">Load Mine Only</button>
      </div>
      <div id="tournamentsStatus" class="muted" style="margin-top:10px;"></div>
      <div id="tournamentsList" class="list"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    let supabase = null;

    const $ = (id) => document.getElementById(id);

    function setStatus(el, msg, type = "") {
      el.className = type ? type : "muted";
      el.textContent = msg;
    }

    function dumpSession(session) {
      $("sessionDump").textContent = JSON.stringify({ session }, null, 2);
    }

    function requireInit() {
      if (!supabase) {
        setStatus($("initStatus"), "Initialize Supabase first.", "err");
        throw new Error("Supabase not initialized");
      }
    }

    async function refreshSessionUI() {
      if (!supabase) return dumpSession(null);
      const { data, error } = await supabase.auth.getSession();
      if (error) {
        setStatus($("authStatus"), error.message, "err");
        dumpSession(null);
        return;
      }
      dumpSession(data.session);
      if (data.session?.user?.id) {
        setStatus($("authStatus"), `Signed in as ${data.session.user.email} (user_id: ${data.session.user.id})`, "ok");
      } else {
        setStatus($("authStatus"), "Not signed in.", "muted");
      }
    }

    $("btnInit").addEventListener("click", async () => {
      const url = $("supabaseUrl").value.trim();
      const key = $("supabaseKey").value.trim();
      if (!url || !key) {
        return setStatus($("initStatus"), "Paste your Supabase URL + Anon key.", "err");
      }

      // IMPORTANT: lock client to the freeagents schema
      supabase = createClient(url, key, { db: { schema: "freeagents" } });

      // keep session UI updated
      supabase.auth.onAuthStateChange((_event, session) => dumpSession(session));

      setStatus($("initStatus"), "Supabase initialized (schema: freeagents).", "ok");
      await refreshSessionUI();
    });

    $("btnClear").addEventListener("click", () => {
      $("supabaseUrl").value = "";
      $("supabaseKey").value = "";
      supabase = null;
      setStatus($("initStatus"), "Cleared.", "muted");
      setStatus($("authStatus"), "", "muted");
      dumpSession(null);
      $("tournamentsList").innerHTML = "";
      setStatus($("tournamentsStatus"), "", "muted");
      setStatus($("createTournamentStatus"), "", "muted");
    });

    // ---- Auth handlers ----
    $("btnSignUp").addEventListener("click", async () => {
      requireInit();
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setStatus($("authStatus"), "Email + password required.", "err");

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) return setStatus($("authStatus"), error.message, "err");

      setStatus($("authStatus"), "Sign-up created. Check email if confirmation is enabled. Then sign in.", "ok");
      await refreshSessionUI();
    });

    $("btnSignIn").addEventListener("click", async () => {
      requireInit();
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return setStatus($("authStatus"), "Email + password required.", "err");

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setStatus($("authStatus"), error.message, "err");

      await refreshSessionUI();
    });

    $("btnMagic").addEventListener("click", async () => {
      requireInit();
      const email = $("email").value.trim();
      if (!email) return setStatus($("authStatus"), "Email required.", "err");

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          // For local file testing, magic links can be finicky.
          // Once you host anywhere (even GitHub Pages), set redirect to that URL.
          emailRedirectTo: window.location.href
        }
      });

      if (error) return setStatus($("authStatus"), error.message, "err");
      setStatus($("authStatus"), "Magic link sent. Check your email.", "ok");
    });

    $("btnSignOut").addEventListener("click", async () => {
      requireInit();
      const { error } = await supabase.auth.signOut();
      if (error) return setStatus($("authStatus"), error.message, "err");
      await refreshSessionUI();
    });

    $("btnRefresh").addEventListener("click", refreshSessionUI);

    // ---- DB: tournaments ----
    $("btnCreateTournament").addEventListener("click", async () => {
      requireInit();
      const { data: sess } = await supabase.auth.getSession();
      const userId = sess?.session?.user?.id;
      if (!userId) return setStatus($("createTournamentStatus"), "You must be signed in (auth.uid() is NULL).", "err");

      const name = $("tName").value.trim();
      const start_date = $("tStart").value;
      const end_date = $("tEnd").value || null;
      const location_city = $("tCity").value.trim() || null;
      const location_state = $("tState").value.trim() || null;

      if (!name || !start_date) return setStatus($("createTournamentStatus"), "Tournament name + start date required.", "err");

      // IMPORTANT: created_by must match auth.uid() per RLS
      const payload = { name, start_date, end_date, location_city, location_state, created_by: userId };

      const { data, error } = await supabase
        .from("tournaments")
        .insert(payload)
        .select("*")
        .single();

      if (error) return setStatus($("createTournamentStatus"), error.message, "err");

      setStatus($("createTournamentStatus"), `Created: ${data.name} (${data.id})`, "ok");
    });

    function renderTournament(t) {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <h4>${escapeHtml(t.name)}</h4>
        <div class="muted">
          <div><b>Dates:</b> ${t.start_date}${t.end_date ? " → " + t.end_date : ""}</div>
          <div><b>Location:</b> ${escapeHtml([t.location_city, t.location_state].filter(Boolean).join(", ") || "—")}</div>
          <div><b>Created by:</b> ${t.created_by}</div>
          <div><b>Verified:</b> ${t.is_verified ? "Yes" : "No"}</div>
          <div><b>ID:</b> <code>${t.id}</code></div>
        </div>
      `;
      return div;
    }

    $("btnLoadTournaments").addEventListener("click", async () => {
      requireInit();
      const { data, error } = await supabase
        .from("tournaments")
        .select("*")
        .order("start_date", { ascending: true });

      if (error) return setStatus($("tournamentsStatus"), error.message, "err");

      $("tournamentsList").innerHTML = "";
      data.forEach(t => $("tournamentsList").appendChild(renderTournament(t)));
      setStatus($("tournamentsStatus"), `Loaded ${data.length} tournaments.`, "ok");
    });

    $("btnLoadMine").addEventListener("click", async () => {
      requireInit();
      const { data: sess } = await supabase.auth.getSession();
      const userId = sess?.session?.user?.id;
      if (!userId) return setStatus($("tournamentsStatus"), "Sign in first.", "err");

      const { data, error } = await supabase
        .from("tournaments")
        .select("*")
        .eq("created_by", userId)
        .order("start_date", { ascending: true });

      if (error) return setStatus($("tournamentsStatus"), error.message, "err");

      $("tournamentsList").innerHTML = "";
      data.forEach(t => $("tournamentsList").appendChild(renderTournament(t)));
      setStatus($("tournamentsStatus"), `Loaded ${data.length} of your tournaments.`, "ok");
    });

    // ---- helpers ----
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[s]);
    }
  </script>
</body>
</html>
