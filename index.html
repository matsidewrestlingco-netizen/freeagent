<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreeAgent MVP</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 22px; max-width: 1200px; }
    h1 { margin: 0 0 8px 0; }
    .muted { color:#666; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    label { display:block; font-size: 12px; color:#444; margin-top: 10px; }
    input, select, button, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; margin-top: 6px; box-sizing: border-box; }
    button { cursor:pointer; font-weight: 650; }
    button.secondary { background:#f4f4f4; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }
    pre { background:#0b1020; color:#e9eefc; padding: 12px; border-radius: 12px; overflow:auto; }
    .ok { color:#0a7a2f; font-weight: 650; }
    .err { color:#b00020; font-weight: 650; }
    .list { display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .item { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .item h4 { margin: 0 0 6px 0; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 8px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f2f2; font-size: 12px; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>FreeAgent MVP</h1>
  <div class="muted">Public board: view tournaments/openings/free agents. Teams must log in to request a free agent.</div>

  <div class="card" style="margin-top:14px;">
    <h3>Auth</h3>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@email.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignUp">Sign up</button>
      <button id="btnSignOut" class="secondary">Sign out</button>
    </div>
    <div id="authStatus" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h3>Tournaments</h3>
      <div class="row">
        <button id="btnLoadTournaments">Load</button>
        <button id="btnRefreshBoard" class="secondary">Refresh Board</button>
      </div>

      <label>Select tournament</label>
      <select id="tournamentSelect"></select>

      <label>Filter by division</label>
      <select id="divisionFilter"></select>

      <div id="tournamentsStatus" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>Session</h3>
      <div class="muted">RLS uses this user id when logged in.</div>
      <pre id="sessionDump">{ "session": null }</pre>

      <div style="margin-top:10px;">
        <label>My slot to fill (required to request)</label>
        <select id="mySlotSelect"></select>
        <div id="mySlotStatus" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h3>Openings Board (Public)</h3>
      <div id="openingsStatus" class="muted"></div>
      <div id="openingsList" class="list"></div>
    </div>

    <div class="card">
      <h3>Free Agents (Public)</h3>
      <div class="muted">Shows: first name, grade, can-make weight. No contact info.</div>
      <div id="agentsStatus" class="muted"></div>
      <div id="agentsList" class="list"></div>
    </div>
  </div>

  <hr style="margin:18px 0;border:none;border-top:1px solid #eee;" />

  <div class="grid">
    <div class="card">
      <h3>Post Availability (Free Agent) — requires login</h3>

      <label>Athlete first name (ex: “Evan”)</label>
      <input id="aName" placeholder="First name only" />

      <div class="row">
        <div>
          <label>Grade (0 = K)</label>
          <input id="aGrade" type="number" min="0" max="12" placeholder="6" />
        </div>
        <div>
          <label>Can make (lbs)</label>
          <input id="aCanMake" type="number" step="0.1" placeholder="100" />
        </div>
      </div>

      <label>Division</label>
      <select id="divisionSelectA"></select>

      <label>Notes (optional)</label>
      <textarea id="aNotes" rows="2" placeholder="Optional. Keep it clean."></textarea>

      <button id="btnPostAvailability" style="margin-top:10px;">Create Athlete + Availability</button>
      <div id="availStatus" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>Post Opening (Team) — requires login</h3>

      <label>Team name</label>
      <input id="teamName" placeholder="Example WC Blue" />

      <label>Division</label>
      <select id="divisionSelectT"></select>

      <label>Approx target max lbs (slot)</label>
      <input id="slotMax" type="number" step="0.1" placeholder="100" />

      <div class="row">
        <div>
          <label>Range min</label>
          <input id="slotMin" type="number" step="0.1" placeholder="98" />
        </div>
        <div>
          <label>Range max</label>
          <input id="slotRangeMax" type="number" step="0.1" placeholder="103" />
        </div>
      </div>

      <label>Notes</label>
      <textarea id="oNotes" rows="2" placeholder="Need a 100 for K–6, willing to bump."></textarea>

      <button id="btnPostOpening" style="margin-top:10px;">Create Team + Opening + Slot</button>
      <div id="openingStatus" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // >>> Replace these:
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: "freeagents" }
    });

    const $ = (id) => document.getElementById(id);
    const set = (el, msg, cls="muted") => { el.className = cls; el.textContent = msg; };

    function dump(session) { $("sessionDump").textContent = JSON.stringify({ session }, null, 2); }

    async function getSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;
      dump(data.session);
      return data.session;
    }

    async function refreshAuthUI() {
      try {
        const session = await getSession();
        if (session?.user?.id) set($("authStatus"), `Signed in as ${session.user.email} (user_id: ${session.user.id})`, "ok");
        else set($("authStatus"), "Not signed in.", "muted");
      } catch (e) {
        set($("authStatus"), e.message, "err");
        dump(null);
      }
      await loadMySlots(); // will no-op if not logged in
      await refreshBoard();
    }

    async function requireUserId() {
      const session = await getSession();
      const uid = session?.user?.id;
      if (!uid) throw new Error("You must be signed in.");
      return uid;
    }

    // ---------- Data loading ----------
    const divisionMap = new Map(); // id -> {name,...}

    async function loadTournaments() {
      const { data, error } = await supabase.from("tournaments").select("*").order("start_date", { ascending: true });
      if (error) { set($("tournamentsStatus"), error.message, "err"); return; }

      $("tournamentSelect").innerHTML = "";
      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.name} (${t.start_date})`;
        $("tournamentSelect").appendChild(opt);
      });

      set($("tournamentsStatus"), `Loaded ${data.length} tournaments.`, "ok");
      await loadDivisionsForSelectedTournament();
      await refreshBoard();
      await loadMySlots();
    }

    async function loadDivisionsForSelectedTournament() {
      divisionMap.clear();
      $("divisionFilter").innerHTML = "";
      $("divisionSelectA").innerHTML = "";
      $("divisionSelectT").innerHTML = "";

      const tid = $("tournamentSelect").value;
      if (!tid) return;

      const { data, error } = await supabase
        .from("divisions")
        .select("*")
        .eq("tournament_id", tid)
        .order("grade_min", { ascending: true });

      if (error) {
        set($("tournamentsStatus"), "Could not load divisions for this tournament. " + error.message, "err");
        return;
      }

      // Division filter includes "All"
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "All divisions";
      $("divisionFilter").appendChild(allOpt);

      data.forEach(d => {
        divisionMap.set(d.id, d);
        const label = `${d.name} (grades ${d.grade_min}-${d.grade_max}, ${d.gender_policy})`;

        const optF = document.createElement("option");
        optF.value = d.id; optF.textContent = label;
        $("divisionFilter").appendChild(optF);

        const optA = document.createElement("option");
        optA.value = d.id; optA.textContent = label;
        const optT = optA.cloneNode(true);
        $("divisionSelectA").appendChild(optA);
        $("divisionSelectT").appendChild(optT);
      });
    }

    async function refreshBoard() {
      const tid = $("tournamentSelect").value;
      if (!tid) return;
      const did = $("divisionFilter").value || null;
      await Promise.all([loadOpenings(tid, did), loadFreeAgents(tid, did)]);
    }

    async function loadOpenings(tournamentId, divisionIdOrNull) {
      set($("openingsStatus"), "Loading openings...", "muted");
      $("openingsList").innerHTML = "";

      // 1) openings + teams (team name)
      let q = supabase
        .from("team_openings")
        .select("id, team_id, division_id, notes, status, created_at, teams!inner(team_name, tournament_id)")
        .eq("teams.tournament_id", tournamentId)
        .eq("status", "ACTIVE")
        .order("created_at", { ascending: false });

      if (divisionIdOrNull) q = q.eq("division_id", divisionIdOrNull);

      const { data: openings, error: oErr } = await q;
      if (oErr) { set($("openingsStatus"), oErr.message, "err"); return; }

      if (!openings.length) {
        set($("openingsStatus"), "No openings yet.", "muted");
        return;
      }

      // 2) get slots for these openings
      const openingIds = openings.map(o => o.id);
      const { data: slots, error: sErr } = await supabase
        .from("opening_slots")
        .select("*")
        .in("opening_id", openingIds);

      if (sErr) { set($("openingsStatus"), sErr.message, "err"); return; }

      const slotsByOpening = new Map();
      (slots || []).forEach(s => {
        if (!slotsByOpening.has(s.opening_id)) slotsByOpening.set(s.opening_id, []);
        slotsByOpening.get(s.opening_id).push(s);
      });

      openings.forEach(o => {
        const d = divisionMap.get(o.division_id);
        const divLabel = d ? d.name : o.division_id;

        const item = document.createElement("div");
        item.className = "item";

        const slotLines = (slotsByOpening.get(o.id) || []).map(s => {
          const parts = [];
          if (s.target_max_lbs != null) parts.push(`≤ ${s.target_max_lbs} lbs`);
          if (s.range_min_lbs != null && s.range_max_lbs != null) parts.push(`${s.range_min_lbs}–${s.range_max_lbs} lbs`);
          if (!parts.length) parts.push("Weight TBD");
          return `• ${parts.join(" / ")} (qty ${s.quantity})`;
        });

        item.innerHTML = `
          <h4>${escapeHtml(o.teams.team_name)} <span class="pill">${escapeHtml(divLabel)}</span></h4>
          <div class="muted">${o.notes ? escapeHtml(o.notes) : ""}</div>
          <div style="margin-top:8px; font-size: 13px;">
            <b>Slots:</b><br/>
            ${slotLines.length ? slotLines.map(x => escapeHtml(x)).join("<br/>") : "—"}
          </div>
        `;
        $("openingsList").appendChild(item);
      });

      set($("openingsStatus"), `Showing ${openings.length} opening(s).`, "ok");
    }

    async function loadFreeAgents(tournamentId, divisionIdOrNull) {
      set($("agentsStatus"), "Loading free agents...", "muted");
      $("agentsList").innerHTML = "";

      let q = supabase
        .from("public_free_agents")
        .select("*")
        .eq("tournament_id", tournamentId)
        .order("created_at", { ascending: false });

      if (divisionIdOrNull) q = q.eq("division_id", divisionIdOrNull);

      const { data, error } = await q;
      if (error) { set($("agentsStatus"), error.message, "err"); return; }

      if (!data.length) {
        set($("agentsStatus"), "No free agents posted yet.", "muted");
        return;
      }

      // Request button enabled only if logged in AND a slot is selected
      const session = await getSession();
      const loggedIn = !!session?.user?.id;

      const slotId = $("mySlotSelect").value || "";

      data.forEach(a => {
        const d = divisionMap.get(a.division_id);
        const divLabel = d ? d.name : a.division_id;

        const item = document.createElement("div");
        item.className = "item";

        const canMake = (a.can_make_lbs == null) ? "—" : `≤ ${a.can_make_lbs} lbs`;
        const grade = (a.grade == null) ? "—" : a.grade;

        item.innerHTML = `
          <h4>${escapeHtml(a.first_name)} <span class="pill">${escapeHtml(divLabel)}</span></h4>
          <div style="font-size: 13px;">
            <b>Grade:</b> ${escapeHtml(String(grade))} &nbsp; • &nbsp; <b>Can make:</b> ${escapeHtml(String(canMake))}
          </div>
          <div class="row" style="margin-top:10px;">
            <button data-availability="${a.availability_id}" ${(!loggedIn || !slotId) ? "disabled" : ""}>
              Request this free agent (fills my selected slot)
            </button>
          </div>
          <div class="muted" style="margin-top:6px;">${(!loggedIn) ? "Log in to request." : (!slotId ? "Select one of your slots above to enable requests." : "")}</div>
        `;

        const btn = item.querySelector("button");
        btn.addEventListener("click", async () => {
          try {
            const uid = await requireUserId();
            const slot_id = $("mySlotSelect").value;
            const availability_id = btn.getAttribute("data-availability");
            if (!slot_id) throw new Error("Select your slot first.");

            const { error: insErr } = await supabase
              .from("match_requests")
              .insert({ slot_id, availability_id, requested_by: uid });

            if (insErr) throw insErr;

            set($("agentsStatus"), "Request sent.", "ok");
          } catch (e) {
            set($("agentsStatus"), e.message, "err");
          }
        });

        $("agentsList").appendChild(item);
      });

      set($("agentsStatus"), `Showing ${data.length} free agent(s).`, "ok");
    }

    // My Slots dropdown: only shows slots I own (teams/openings I created)
    async function loadMySlots() {
      $("mySlotSelect").innerHTML = "";
      set($("mySlotStatus"), "", "muted");

      const tid = $("tournamentSelect").value;
      if (!tid) return;

      const session = await getSession();
      const uid = session?.user?.id;
      if (!uid) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Sign in to select your slot";
        $("mySlotSelect").appendChild(opt);
        return;
      }

      // Find openings I created for this tournament -> their slots
      const { data: myOpenings, error: oErr } = await supabase
        .from("team_openings")
        .select("id, division_id, created_at, teams!inner(team_name, tournament_id)")
        .eq("created_by", uid)
        .eq("teams.tournament_id", tid)
        .order("created_at", { ascending: false });

      if (oErr) { set($("mySlotStatus"), oErr.message, "err"); return; }

      if (!myOpenings.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No slots yet (create an opening below)";
        $("mySlotSelect").appendChild(opt);
        return;
      }

      const openingIds = myOpenings.map(o => o.id);
      const { data: slots, error: sErr } = await supabase
        .from("opening_slots")
        .select("*")
        .in("opening_id", openingIds);

      if (sErr) { set($("mySlotStatus"), sErr.message, "err"); return; }

      const openingById = new Map(myOpenings.map(o => [o.id, o]));
      (slots || []).forEach(s => {
        const o = openingById.get(s.opening_id);
        const d = divisionMap.get(o?.division_id);
        const divLabel = d ? d.name : (o?.division_id || "—");

        const parts = [];
        if (s.target_max_lbs != null) parts.push(`≤${s.target_max_lbs}`);
        if (s.range_min_lbs != null && s.range_max_lbs != null) parts.push(`${s.range_min_lbs}-${s.range_max_lbs}`);
        const weightLabel = parts.length ? parts.join(" / ") : "TBD";

        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${o?.teams?.team_name || "My Team"} • ${divLabel} • ${weightLabel}`;
        $("mySlotSelect").appendChild(opt);
      });

      set($("mySlotStatus"), `Loaded ${slots?.length || 0} of your slot(s).`, "ok");
    }

    // ---------- Posting (requires login) ----------
    $("btnPostAvailability").addEventListener("click", async () => {
      try {
        const uid = await requireUserId();
        const tid = $("tournamentSelect").value;
        const division_id = $("divisionSelectA").value;

        const display_name = $("aName").value.trim();
        const grade = $("aGrade").value ? Number($("aGrade").value) : null;
        const can_make_lbs = $("aCanMake").value ? Number($("aCanMake").value) : null;
        const notes = $("aNotes").value.trim() || null;

        if (!display_name || !division_id) throw new Error("First name + division required.");

        const { data: athlete, error: aErr } = await supabase
          .from("athletes")
          .insert({ guardian_user_id: uid, display_name, grade, can_make_lbs })
          .select("*")
          .single();
        if (aErr) throw aErr;

        const { error: vErr } = await supabase
          .from("athlete_availability")
          .insert({ athlete_id: athlete.id, tournament_id: tid || null, division_id, notes, created_by: uid });
        if (vErr) throw vErr;

        set($("availStatus"), "Availability posted.", "ok");
        await refreshBoard();
      } catch (e) {
        set($("availStatus"), e.message, "err");
      }
    });

    $("btnPostOpening").addEventListener("click", async () => {
      try {
        const uid = await requireUserId();
        const tid = $("tournamentSelect").value;
        const division_id = $("divisionSelectT").value;
        const team_name = $("teamName").value.trim();
        const notes = $("oNotes").value.trim() || null;

        const target_max_lbs = $("slotMax").value ? Number($("slotMax").value) : null;
        const range_min_lbs = $("slotMin").value ? Number($("slotMin").value) : null;
        const range_max_lbs = $("slotRangeMax").value ? Number($("slotRangeMax").value) : null;

        if (!tid) throw new Error("Select a tournament.");
        if (!team_name || !division_id) throw new Error("Team name + division required.");
        if (!target_max_lbs && !(range_min_lbs != null && range_max_lbs != null)) throw new Error("Provide target max OR a min/max range.");

        const { data: team, error: tErr } = await supabase
          .from("teams")
          .insert({ tournament_id: tid, team_name, created_by: uid })
          .select("*")
          .single();
        if (tErr) throw tErr;

        const { data: opening, error: oErr } = await supabase
          .from("team_openings")
          .insert({ team_id: team.id, division_id, notes, created_by: uid })
          .select("*")
          .single();
        if (oErr) throw oErr;

        const { error: sErr } = await supabase
          .from("opening_slots")
          .insert({ opening_id: opening.id, target_max_lbs, range_min_lbs, range_max_lbs, quantity: 1 });
        if (sErr) throw sErr;

        set($("openingStatus"), "Opening posted.", "ok");
        await loadMySlots();
        await refreshBoard();
      } catch (e) {
        set($("openingStatus"), e.message, "err");
      }
    });

    // ---------- Auth buttons ----------
    $("btnSignIn").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return set($("authStatus"), "Email + password required.", "err");
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return set($("authStatus"), error.message, "err");
      await refreshAuthUI();
    });

    $("btnSignUp").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return set($("authStatus"), "Email + password required.", "err");
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) return set($("authStatus"), error.message, "err");
      set($("authStatus"), "Sign-up created. If confirmation is on, check your email.", "ok");
      await refreshAuthUI();
    });

    $("btnSignOut").addEventListener("click", async () => {
      const { error } = await supabase.auth.signOut();
      if (error) return set($("authStatus"), error.message, "err");
      await refreshAuthUI();
    });

    // ---------- UI handlers ----------
    $("btnLoadTournaments").addEventListener("click", loadTournaments);
    $("btnRefreshBoard").addEventListener("click", refreshBoard);

    $("tournamentSelect").addEventListener("change", async () => {
      await loadDivisionsForSelectedTournament();
      await loadMySlots();
      await refreshBoard();
    });

    $("divisionFilter").addEventListener("change", refreshBoard);

    // ---------- helpers ----------
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[s]);
    }

    // initial boot
    supabase.auth.onAuthStateChange(() => refreshAuthUI());
    refreshAuthUI().then(loadTournaments).catch(()=>{});
  </script>
</body>
</html>
