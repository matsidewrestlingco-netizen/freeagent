<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FreeAgent MVP</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 22px; max-width: 1100px; }
    h1 { margin: 0 0 8px 0; }
    .muted { color:#666; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    label { display:block; font-size: 12px; color:#444; margin-top: 10px; }
    input, select, button, textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; margin-top: 6px; box-sizing: border-box; }
    button { cursor:pointer; font-weight: 650; }
    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }
    pre { background:#0b1020; color:#e9eefc; padding: 12px; border-radius: 12px; overflow:auto; }
    .ok { color:#0a7a2f; font-weight: 650; }
    .err { color:#b00020; font-weight: 650; }
    .list { display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .item { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .item h4 { margin: 0 0 6px 0; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>FreeAgent MVP</h1>
  <div class="muted">Repo: <code>freeagent</code> · Schema: <code>freeagents</code></div>

  <div class="card" style="margin-top:14px;">
    <h3>Auth</h3>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@email.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnSignIn">Sign in</button>
      <button id="btnSignUp">Sign up</button>
      <button id="btnSignOut">Sign out</button>
    </div>
    <div id="authStatus" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h3>Tournaments</h3>
      <div class="row">
        <button id="btnLoadTournaments">Load</button>
      </div>
      <label>Select tournament</label>
      <select id="tournamentSelect"></select>
      <div id="tournamentsStatus" class="muted" style="margin-top:10px;"></div>
      <div id="tournamentsList" class="list"></div>
    </div>

    <div class="card">
      <h3>Session</h3>
      <div class="muted">RLS depends on this user id.</div>
      <pre id="sessionDump">{ "session": null }</pre>
    </div>
  </div>

  <div class="grid" style="margin-top:14px;">
    <div class="card">
      <h3>Post Availability (Free Agent)</h3>

      <label>Athlete display name (ex: “Evan E.”)</label>
      <input id="aName" placeholder="First name + last initial" />

      <div class="row">
        <div>
          <label>Grade (0 = K)</label>
          <input id="aGrade" type="number" min="0" max="12" placeholder="6" />
        </div>
        <div>
          <label>Can make (lbs)</label>
          <input id="aCanMake" type="number" step="0.1" placeholder="100" />
        </div>
      </div>

      <label>Division (must exist for the tournament)</label>
      <select id="divisionSelectA"></select>

      <label>Notes</label>
      <textarea id="aNotes" rows="2" placeholder="Can bump up 2 lbs, can wrestle 2 duals, etc."></textarea>

      <button id="btnPostAvailability" style="margin-top:10px;">Create Athlete + Availability</button>
      <div id="availStatus" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h3>Post Opening (Team Needs Wrestler)</h3>

      <label>Team name</label>
      <input id="teamName" placeholder="Example WC Blue" />

      <label>Division (must exist for the tournament)</label>
      <select id="divisionSelectT"></select>

      <label>Approx target max lbs (slot)</label>
      <input id="slotMax" type="number" step="0.1" placeholder="100" />

      <div class="row">
        <div>
          <label>Range min</label>
          <input id="slotMin" type="number" step="0.1" placeholder="98" />
        </div>
        <div>
          <label>Range max</label>
          <input id="slotRangeMax" type="number" step="0.1" placeholder="103" />
        </div>
      </div>

      <label>Notes</label>
      <textarea id="oNotes" rows="2" placeholder="Need a 100 for K–6, willing to bump."></textarea>

      <button id="btnPostOpening" style="margin-top:10px;">Create Team + Opening + Slot</button>
      <div id="openingStatus" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // >>> Replace these:
    const SUPABASE_URL = "https://polfteqwekkhzlhfjhsn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvbGZ0ZXF3ZWtraHpsaGZqaHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTU2MzAsImV4cCI6MjA4MDY5MTYzMH0.npJCJJKOLTQddFH-xtU_ZtlT9_M8JWWpScDIsZAGY4M";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: "freeagents" }
    });

    const $ = (id) => document.getElementById(id);
    const set = (el, msg, cls="muted") => { el.className = cls; el.textContent = msg; };

    function dump(session) { $("sessionDump").textContent = JSON.stringify({ session }, null, 2); }

    async function refreshSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) { set($("authStatus"), error.message, "err"); dump(null); return null; }
      dump(data.session);
      if (data.session?.user?.id) {
        set($("authStatus"), `Signed in as ${data.session.user.email} (user_id: ${data.session.user.id})`, "ok");
      } else {
        set($("authStatus"), "Not signed in.", "muted");
      }
      return data.session;
    }

    supabase.auth.onAuthStateChange((_e, session) => dump(session));

    async function requireUser() {
      const session = await refreshSession();
      const uid = session?.user?.id;
      if (!uid) throw new Error("Sign in first.");
      return uid;
    }

    async function loadTournaments() {
      const { data, error } = await supabase.from("tournaments").select("*").order("start_date", { ascending: true });
      if (error) { set($("tournamentsStatus"), error.message, "err"); return []; }

      $("tournamentsList").innerHTML = "";
      $("tournamentSelect").innerHTML = "";

      data.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.name} (${t.start_date})`;
        $("tournamentSelect").appendChild(opt);

        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `
          <h4>${escapeHtml(t.name)}</h4>
          <div class="muted">
            <div><b>Date:</b> ${t.start_date}${t.end_date ? " → " + t.end_date : ""}</div>
            <div><b>Location:</b> ${escapeHtml([t.location_city, t.location_state].filter(Boolean).join(", ") || "—")}</div>
            <div><b>ID:</b> <code>${t.id}</code></div>
          </div>`;
        $("tournamentsList").appendChild(item);
      });

      set($("tournamentsStatus"), `Loaded ${data.length} tournaments.`, "ok");
      await loadDivisionsForSelectedTournament();
      return data;
    }

    async function loadDivisionsForSelectedTournament() {
      const tid = $("tournamentSelect").value;
      if (!tid) return;

      const { data, error } = await supabase
        .from("divisions")
        .select("*")
        .eq("tournament_id", tid)
        .order("grade_min", { ascending: true });

      $("divisionSelectA").innerHTML = "";
      $("divisionSelectT").innerHTML = "";

      if (error) {
        const msg = "Could not load divisions. Create divisions for this tournament in SQL first.";
        set($("tournamentsStatus"), msg + " " + error.message, "err");
        return;
      }

      data.forEach(d => {
        const label = `${d.name} (grades ${d.grade_min}-${d.grade_max}, ${d.gender_policy})`;
        const opt1 = document.createElement("option");
        opt1.value = d.id; opt1.textContent = label;
        const opt2 = opt1.cloneNode(true);
        $("divisionSelectA").appendChild(opt1);
        $("divisionSelectT").appendChild(opt2);
      });
    }

    // ---- Auth buttons ----
    $("btnSignIn").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return set($("authStatus"), "Email + password required.", "err");
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return set($("authStatus"), error.message, "err");
      await refreshSession();
    });

    $("btnSignUp").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) return set($("authStatus"), "Email + password required.", "err");
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) return set($("authStatus"), error.message, "err");
      set($("authStatus"), "Sign-up created. If email confirmation is enabled, check your inbox.", "ok");
      await refreshSession();
    });

    $("btnSignOut").addEventListener("click", async () => {
      const { error } = await supabase.auth.signOut();
      if (error) return set($("authStatus"), error.message, "err");
      await refreshSession();
    });

    // ---- Tournament loading ----
    $("btnLoadTournaments").addEventListener("click", loadTournaments);
    $("tournamentSelect").addEventListener("change", loadDivisionsForSelectedTournament);

    // ---- Post Availability ----
    $("btnPostAvailability").addEventListener("click", async () => {
      try {
        const uid = await requireUser();
        const tid = $("tournamentSelect").value;
        const division_id = $("divisionSelectA").value;
        const display_name = $("aName").value.trim();
        const grade = $("aGrade").value ? Number($("aGrade").value) : null;
        const can_make_lbs = $("aCanMake").value ? Number($("aCanMake").value) : null;
        const notes = $("aNotes").value.trim() || null;

        if (!display_name || !division_id) throw new Error("Athlete name + division required.");

        const { data: athlete, error: aErr } = await supabase
          .from("athletes")
          .insert({ guardian_user_id: uid, display_name, grade, can_make_lbs })
          .select("*")
          .single();
        if (aErr) throw aErr;

        const { data: avail, error: vErr } = await supabase
          .from("athlete_availability")
          .insert({ athlete_id: athlete.id, tournament_id: tid || null, division_id, notes, created_by: uid })
          .select("*")
          .single();
        if (vErr) throw vErr;

        set($("availStatus"), `Posted availability (${avail.id}).`, "ok");
      } catch (e) {
        set($("availStatus"), e.message, "err");
      }
    });

    // ---- Post Opening ----
    $("btnPostOpening").addEventListener("click", async () => {
      try {
        const uid = await requireUser();
        const tid = $("tournamentSelect").value;
        const division_id = $("divisionSelectT").value;
        const team_name = $("teamName").value.trim();
        const notes = $("oNotes").value.trim() || null;

        const target_max_lbs = $("slotMax").value ? Number($("slotMax").value) : null;
        const range_min_lbs = $("slotMin").value ? Number($("slotMin").value) : null;
        const range_max_lbs = $("slotRangeMax").value ? Number($("slotRangeMax").value) : null;

        if (!tid) throw new Error("Select a tournament.");
        if (!team_name || !division_id) throw new Error("Team name + division required.");
        if (!target_max_lbs && !(range_min_lbs && range_max_lbs)) throw new Error("Provide target max or a min/max range.");

        const { data: team, error: tErr } = await supabase
          .from("teams")
          .insert({ tournament_id: tid, team_name, created_by: uid })
          .select("*")
          .single();
        if (tErr) throw tErr;

        const { data: opening, error: oErr } = await supabase
          .from("team_openings")
          .insert({ team_id: team.id, division_id, notes, created_by: uid })
          .select("*")
          .single();
        if (oErr) throw oErr;

        const { data: slot, error: sErr } = await supabase
          .from("opening_slots")
          .insert({
            opening_id: opening.id,
            target_max_lbs,
            range_min_lbs,
            range_max_lbs,
            quantity: 1
          })
          .select("*")
          .single();
        if (sErr) throw sErr;

        set($("openingStatus"), `Posted opening (${opening.id}) + slot (${slot.id}).`, "ok");
      } catch (e) {
        set($("openingStatus"), e.message, "err");
      }
    });

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      })[s]);
    }

    // initial
    refreshSession().then(loadTournaments).catch(()=>{});
  </script>
</body>
</html>
